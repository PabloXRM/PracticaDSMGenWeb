@model IEnumerable<DSM.Models.ProductoViewModel>

@{
    ViewData["Title"] = "Productos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="section section-product-hero">
    <div class="section-inner">
        <header class="section-header section-header-row">
            <div>
                <span class="section-kicker">Catálogo completo</span>
                <h2>Productos</h2>
            </div>

            <div class="product-hero-actions">
                <a asp-action="Create" class="btn primary-btn btn-sm">
                    + Crear nuevo producto
                </a>
            </div>
        </header>

        <p class="section-subtitle">
            Gestiona todos los vinilos, CDs y coleccionables del catálogo.
        </p>
    </div>
</section>

<section class="section section-product-list">
    <div class="section-inner">

        @if (Model == null || !Model.Any())
        {
            <p>No hay productos disponibles.</p>
        }
        else
        {
            <div class="cards-row product-grid">
                @foreach (var item in Model)
                {
                    <article class="disc-card product-card">

                        <div class="product-image-wrapper">
                            @{
                                var fallback = Url.Content("~/img/cd1.png");
                                var foto = fallback;

                                var raw = item?.Fotos?.Trim();

                                if (!string.IsNullOrWhiteSpace(raw))
                                {
                                    // Si viene una lista tipo "a.png;b.png" o "a.png,b.png", coger la primera
                                    raw = raw.Split(';', ',')[0].Trim();

                                    // Quitar comillas si viniera "\"cd1.png\""
                                    raw = raw.Trim('\"', '\'');

                                    // 1) URL absoluta
                                    if (raw.StartsWith("http://", StringComparison.OrdinalIgnoreCase) ||
                                    raw.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
                                    {
                                        foto = raw;
                                    }
                                    // 2) Rutas web absolutas o con ~
                                    else if (raw.StartsWith("~/", StringComparison.Ordinal) || raw.StartsWith("/", StringComparison.Ordinal))
                                    {
                                        foto = Url.Content(raw.StartsWith("~/", StringComparison.Ordinal) ? raw : ("~" + raw));
                                    }
                                    // 3) Rutas con carpeta relativa tipo "img/a.png" o "Images/a.png"
                                    else if (raw.StartsWith("img/", StringComparison.OrdinalIgnoreCase) ||
                                    raw.StartsWith("images/", StringComparison.OrdinalIgnoreCase))
                                    {
                                        foto = Url.Content("~/" + raw.TrimStart('/'));
                                    }
                                    // 4) Rutas Windows o inválidas para web -> fallback
                                    else if (raw.Contains(@"\") || raw.Contains(":"))
                                    {
                                        foto = fallback;
                                    }
                                    // 5) Solo nombre de fichero -> asumir wwwroot/img/
                                    else
                                    {
                                        foto = Url.Content("~/img/" + raw.TrimStart('/'));
                                    }
                                }
                            }
                            <img src="@foto"
                                 alt="@(item?.Descripcion ?? "Producto")"
                                 onerror="this.onerror=null;this.src='@Url.Content("~/img/cd1.png")';"
                                 loading="lazy" />
                        </div>

                        <div class="disc-info product-info">
                            <h3>@item.Descripcion</h3>

                            <div class="product-meta">
                                <span class="disc-price">
                                    @String.Format("{0:0.00} €", item.Precio)
                                </span>

                                <span class="product-stock @(item.Stock > 0 ? "product-stock--ok" : "product-stock--out")">
                                    @(item.Stock > 0 ? $"Stock: {item.Stock}" : "Sin stock")
                                </span>
                            </div>

                            <div class="product-actions">
                                <a asp-action="Details" asp-route-id="@item.Id" class="btn ghost-btn btn-sm">Detalles</a>
                                <a asp-action="Edit" asp-route-id="@item.Id" class="btn primary-btn btn-sm">Editar</a>
                                <a asp-action="Delete" asp-route-id="@item.Id" class="btn ghost-btn btn-sm product-delete"
                                   onclick="return confirm('¿Estás seguro de que quieres borrar este producto?');">
                                    Borrar
                                </a>
                            </div>
                        </div>

                    </article>
                }
            </div>
        }

    </div>
</section>
