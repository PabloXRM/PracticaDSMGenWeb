@model DSM.Models.HomeIndexViewModel
@{
    ViewData["Title"] = "Resultados";
}

<section class="section">
    <div class="section-header section-header-row">
        <h2>Resultados</h2>
        <a class="btn ghost-btn" asp-controller="Home" asp-action="Index">Volver</a>
    </div>

    @if (Model.Productos != null && Model.Productos.Count > 0)
    {
        <div class="shop-grid">
            @foreach (var p in Model.Productos)
            {
                <article class="shop-card">
                    <a class="shop-card-link" asp-controller="Tienda" asp-action="Producto" asp-route-id="@p.Id">
                        <div class="shop-img">
                            @{
                                // Fallback SIEMPRE válido
                                var fallback = Url.Content("~/img/cd1.png");
                                var foto = fallback;

                                var raw = p?.Fotos?.Trim();

                                if (!string.IsNullOrWhiteSpace(raw))
                                {
                                    // Si viene una lista tipo "a.png;b.png" o "a.png,b.png", coger la primera
                                    raw = raw.Split(';', ',')[0].Trim();

                                    // Quitar comillas si viniera "\"cd1.png\""
                                    raw = raw.Trim('\"', '\'');

                                    // 1) URL absoluta
                                    if (raw.StartsWith("http://", StringComparison.OrdinalIgnoreCase) ||
                                    raw.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
                                    {
                                        foto = raw;
                                    }
                                    // 2) Rutas web absolutas o con ~
                                    else if (raw.StartsWith("~/", StringComparison.Ordinal) || raw.StartsWith("/", StringComparison.Ordinal))
                                    {
                                        foto = Url.Content(raw.StartsWith("~/", StringComparison.Ordinal) ? raw : ("~" + raw));
                                    }
                                    // 3) Rutas con carpeta relativa tipo "img/a.png" o "Images/a.png"
                                    else if (raw.StartsWith("img/", StringComparison.OrdinalIgnoreCase) ||
                                    raw.StartsWith("images/", StringComparison.OrdinalIgnoreCase))
                                    {
                                        foto = Url.Content("~/" + raw.TrimStart('/'));
                                    }
                                    // 4) Rutas Windows o inválidas para web -> fallback
                                    else if (raw.Contains(@"\") || raw.Contains(":"))
                                    {
                                        foto = fallback;
                                    }
                                    // 5) Solo nombre de fichero -> asumir wwwroot/img/
                                    else
                                    {
                                        foto = Url.Content("~/img/" + raw.TrimStart('/'));
                                    }
                                }
                            }

                            <img src="@foto"
                                 alt="@(p?.Descripcion ?? "Producto")"
                                 onerror="this.onerror=null;this.src='@Url.Content("~/img/cd1.png")';"
                                 loading="lazy" />
                        </div>

                        <div class="shop-info">
                            <h3 class="shop-title">@p.Descripcion</h3>

                            <div class="shop-meta">
                                <span class="shop-price">@String.Format("{0:0.00} €", p.Precio)</span>
                                <span class="shop-stockpill">STOCK: @p.Stock</span>
                            </div>

                            <div class="shop-actions">
                                <span class="btn ghost-btn btn-sm">Ver detalles</span>
                            </div>
                        </div>
                    </a>
                </article>
            }
        </div>
    }
    else
    {
        <p style="opacity:.7;">No hay productos para esos filtros.</p>
    }
</section>
