@using DSM.Models

@{
    ViewData["Title"] = "Factura de Pedido";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var pedido = ViewBag.Pedido as PedidoViewModel;
    var lineas = ViewBag.Lineas as List<DSM.Models.LineaPedidoViewModel>;
    var factura = ViewBag.Factura as PracticaDSMGen.ApplicationCore.EN.PracticaDSM.FacturaEN;
    var usuario = ViewBag.Usuario as UsuarioViewModel;
}

<section class="section form-page">
    <div class="form-card" style="max-width: 800px;">
        
        <!-- Encabezado de Factura -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid var(--color-primary); padding-bottom: 20px;">
            <h1 style="margin: 0; color: var(--color-primary);">TempoShop</h1>
            <p style="margin: 5px 0 0 0; color: var(--color-muted);">Factura de Compra</p>
        </div>

        <!-- Información de la Factura -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div>
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 0.8rem; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.1em;">Número de Pedido</label>
                    <div style="font-size: 1.1rem; font-weight: 700;">@pedido?.Numero</div>
                </div>
                <div>
                    <label style="font-size: 0.8rem; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.1em;">Fecha de Pedido</label>
                    <div style="font-size: 1rem;">@(pedido != null ? pedido.Fecha.ToString("dd/MM/yyyy") : "")</div>
                </div>
            </div>

            @if (factura != null)
            {
                <div>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.8rem; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.1em;">Número de Factura</label>
                        <div style="font-size: 1.1rem; font-weight: 700;">@factura.Numero</div>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.1em;">Fecha de Factura</label>
                        <div style="font-size: 1rem;">@(factura.Fecha.HasValue ? factura.Fecha.Value.ToString("dd/MM/yyyy") : "")</div>
                    </div>
                </div>
            }
        </div>

        <!-- Información del Cliente -->
        <div style="background: rgba(0,0,0,0.03); padding: 15px; border-radius: 12px; margin-bottom: 30px;">
            <label style="font-size: 0.8rem; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.1em; display: block; margin-bottom: 8px;">Cliente</label>
            <div style="font-weight: 700;">@usuario?.Nombre</div>
            <div style="color: var(--color-muted);">@usuario?.email</div>
            <div style="color: var(--color-muted); margin-top: 5px;">@usuario?.Direccion</div>
            <div style="color: var(--color-muted);">CP: @usuario?.CodPostal</div>
        </div>

        <!-- Tabla de Artículos -->
        @if (lineas != null && lineas.Count > 0)
        {
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                <thead>
                    <tr style="background: var(--color-primary-soft); border-bottom: 2px solid var(--color-primary);">
                        <th style="padding: 12px; text-align: left; font-weight: 700; text-transform: uppercase; font-size: 0.85rem;">Producto</th>
                        <th style="padding: 12px; text-align: center; font-weight: 700; text-transform: uppercase; font-size: 0.85rem;">Cantidad</th>
                        <th style="padding: 12px; text-align: right; font-weight: 700; text-transform: uppercase; font-size: 0.85rem;">Precio Unit.</th>
                        <th style="padding: 12px; text-align: right; font-weight: 700; text-transform: uppercase; font-size: 0.85rem;">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        decimal totalLineas = 0;
                    }
                    @foreach (var linea in lineas)
                    {
                        // linea.Precio almacena el precio total (unitario × cantidad)
                        // Calcular precio unitario dividiendo por la cantidad
                        decimal precioTotal = (decimal)(linea.Precio);
                        decimal precioUnitario = linea.Cantidad > 0 ? precioTotal / linea.Cantidad : 0;
                        decimal subtotal = precioUnitario * linea.Cantidad;
                        totalLineas += subtotal;

                        <tr style="border-bottom: 1px solid rgba(0,0,0,0.1);">
                            <td style="padding: 12px; text-align: left;">@linea.Producto?.Descripcion</td>
                            <td style="padding: 12px; text-align: center;">@linea.Cantidad</td>
                            <td style="padding: 12px; text-align: right;">@String.Format("{0:0.00} €", precioUnitario)</td>
                            <td style="padding: 12px; text-align: right; font-weight: 600;">@String.Format("{0:0.00} €", subtotal)</td>
                        </tr>
                    }
                </tbody>
            </table>

            <!-- Resumen de Totales -->
            <div style="display: flex; justify-content: flex-end; margin-bottom: 30px;">
                <div style="width: 300px;">
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.1);">
                        <span>Subtotal:</span>
                        <span>@String.Format("{0:0.00} €", totalLineas)</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 2px solid var(--color-primary); font-weight: 700; font-size: 1.2rem; color: var(--color-primary);">
                        <span>Total:</span>
                        <span>@String.Format("{0:0.00} €", pedido?.TotalPrecio)</span>
                    </div>
                </div>
            </div>
        }

        <!-- Estado del Pedido -->
        <div style="background: var(--color-primary-soft); padding: 15px; border-radius: 12px; margin-bottom: 30px; text-align: center;">
            <label style="font-size: 0.8rem; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.1em; display: block; margin-bottom: 8px;">Estado del Pedido</label>
            <div style="font-size: 1.1rem; font-weight: 700; color: var(--color-primary);">@pedido?.EstadoPedido</div>
        </div>

        <!-- Nota Legal -->
        <div style="background: rgba(0,0,0,0.02); padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--color-primary);">
            <p style="margin: 0; font-size: 0.85rem; color: var(--color-muted); line-height: 1.5;">
                Esta es una factura digital de TempoShop. Conserva este documento para tus registros. 
                Si tienes preguntas sobre tu pedido, contacta con nuestro servicio de atención al cliente.
            </p>
        </div>

        <!-- Botones de Acción -->
        <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.1);">
            <a asp-controller="Pedido" asp-action="Index" class="btn ghost-btn">Volver a mis pedidos</a>
            <button class="btn primary-btn" onclick="window.print();">Imprimir factura</button>
        </div>

    </div>
</section>

<style>
    @@media print {
        .section, .form-card {
            margin: 0 !important;
            padding: 0 !important;
            box-shadow: none !important;
            background: #fff !important;
        }

        .btn {
            display: none !important;
        }

        body {
            background: #fff !important;
        }
    }
</style>
